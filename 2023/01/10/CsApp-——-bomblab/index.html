<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>CsApp —— Bomb Lab | 温温卡的blog</title><meta name="author" content="wenwenka,wu290063155@gmail.com"><meta name="copyright" content="wenwenka"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="由于几乎是个c语言小白，之前从未接触过gdb。因此在做实验前，先简单科普一下gdb的用法。在查阅相关资料时，发现cgdb是gdb的可视化版本，因此推荐大家可以使用cdgb来做本实验。 可以通过以下命令安装cgdb： 1sudo apt-get install cgdb  cgdb的相关用法：   按esc键，会进入source界面，即源代码的部分；按i键，则会进入gdb的部分。   鼠标滚轮：滚动">
<meta property="og:type" content="article">
<meta property="og:title" content="CsApp —— Bomb Lab">
<meta property="og:url" content="http://example.com/2023/01/10/CsApp-%E2%80%94%E2%80%94-bomblab/index.html">
<meta property="og:site_name" content="温温卡的blog">
<meta property="og:description" content="由于几乎是个c语言小白，之前从未接触过gdb。因此在做实验前，先简单科普一下gdb的用法。在查阅相关资料时，发现cgdb是gdb的可视化版本，因此推荐大家可以使用cdgb来做本实验。 可以通过以下命令安装cgdb： 1sudo apt-get install cgdb  cgdb的相关用法：   按esc键，会进入source界面，即源代码的部分；按i键，则会进入gdb的部分。   鼠标滚轮：滚动">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2023/01/10/CsApp-%E2%80%94%E2%80%94-bomblab/cover.jpg">
<meta property="article:published_time" content="2023-01-10T15:07:12.000Z">
<meta property="article:modified_time" content="2023-01-12T14:55:19.542Z">
<meta property="article:author" content="wenwenka">
<meta property="article:tag" content="CsApp">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2023/01/10/CsApp-%E2%80%94%E2%80%94-bomblab/cover.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2023/01/10/CsApp-%E2%80%94%E2%80%94-bomblab/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'CsApp —— Bomb Lab',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-01-12 22:55:19'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.2"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">6</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">2</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">2</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/2023/01/10/CsApp-%E2%80%94%E2%80%94-bomblab/cover.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">温温卡的blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">CsApp —— Bomb Lab</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-01-10T15:07:12.000Z" title="发表于 2023-01-10 23:07:12">2023-01-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-01-12T14:55:19.542Z" title="更新于 2023-01-12 22:55:19">2023-01-12</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/">计算机基础</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="CsApp —— Bomb Lab"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>由于几乎是个c语言小白，之前从未接触过gdb。因此在做实验前，先简单科普一下gdb的用法。<br>在查阅相关资料时，发现cgdb是gdb的可视化版本，因此推荐大家可以使用cdgb来做本实验。</p>
<p>可以通过以下命令安装cgdb：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install cgdb</span><br></pre></td></tr></table></figure>

<h5 id="cgdb的相关用法："><a href="#cgdb的相关用法：" class="headerlink" title="cgdb的相关用法："></a>cgdb的相关用法：</h5><ul>
<li>  按esc键，会进入source界面，即源代码的部分；按i键，则会进入gdb的部分。</li>
<li>  鼠标滚轮：滚动浏览源代码</li>
<li>  按键<code>s</code>: 鼠标滚轮可以滚动浏览<code>gdb</code>的调试窗口</li>
<li>  按键<code>-</code>/<code>+</code>：按25%的比例来缩小放大源代码窗口</li>
<li>  按键<code>Ctrl+W</code>： 切换源代码窗口和调试窗口的布局（上下/左右）</li>
<li>  按键<code>空格</code>：当前行打断点；或者进入GDB窗口，输入b + 行号，也能打上断点</li>
<li>  查找代码：在source窗口，输入/，然后输入关键字，n查找下一个,N查找上一个</li>
<li>  按键c：在gdb中输入’c’，即可运行到断点位置</li>
</ul>
<p>下面这篇文章中关于gdb的命令更多：<a target="_blank" rel="noopener" href="https://earthaa.github.io/2020/01/12/CSAPP-Bomblab/">《深入理解计算机系统》Bomb Lab实验解析 | Yi’s Blog (earthaa.github.io)</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/wulichenai/p/14130721.html">【深入理解计算机系统】CSAPP Bomb Lab实验 - 雾里尘埃 - 博客园 (cnblogs.com)</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/451623574">手把手教你拆解 CSAPP 的 炸弹实验室 BombLab - 知乎 (zhihu.com)</a></p>
<p>如果我们想打开另一个文件，则可以在source窗口，按o打开文件浏览窗口，可以进行文件选择，回车打开，如果文件太多，可以按/，然后输入文件名进行查找。<br>在做题之前，我们需要记住几个储存参数的寄存器：<br><img src="20230102204928.png"></p>
<h3 id="phase-1"><a href="#phase-1" class="headerlink" title="phase_1"></a>phase_1</h3><p>反汇编phase_1得到以下结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0000000000400ee0 &lt;phase_1&gt;:</span><br><span class="line">  400ee0:	48 83 ec 08          	sub    $0x8,%rsp</span><br><span class="line">  400ee4:	be 00 24 40 00       	mov    $0x402400,%esi</span><br><span class="line">  400ee9:	e8 4a 04 00 00       	call   401338 &lt;strings_not_equal&gt;</span><br><span class="line">  400eee:	85 c0                	test   %eax,%eax</span><br><span class="line">  400ef0:	74 05                	je     400ef7 &lt;phase_1+0x17&gt;</span><br><span class="line">  400ef2:	e8 43 05 00 00       	call   40143a &lt;explode_bomb&gt;</span><br><span class="line">  400ef7:	48 83 c4 08          	add    $0x8,%rsp</span><br><span class="line">  400efb:	c3                   	ret    </span><br></pre></td></tr></table></figure>
<p>这里我们需要注意，phase_1的参数，是存在%rdi中的，然后phase_1函数里面，0x402400的结果存在了%esi中，然后就是调用strings_not_equal函数，来判断%rdi和%rsi的两个字符串是否相等。（其实strings_not_equal内部比较复杂，但是phase_1只有%rdi和%esi，因此只考虑这俩就行），所以通过题意，我们发现只要输入和0x402400所存的字符串相同，即可完成第一阶段的破解。<br>查看0x402400的字符串可以通过两种方式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(gdb) print (char *) 0x402400</span><br><span class="line">// 结果为：$1 = 0x402400 &quot;Border relations with Canada have never been better.&quot;</span><br><span class="line">(gdb) x/s 0x402400</span><br><span class="line">// 结果为：0x402400:       &quot;Border relations with Canada have never been better.&quot;  </span><br></pre></td></tr></table></figure>

<p>下面是第一关通过以后的提示：<br><img src="20230102213607.png"></p>
<h3 id="phase-2"><a href="#phase-2" class="headerlink" title="phase_2"></a>phase_2</h3><p>本题相较第一关更复杂些。首先还是从phase_2入手：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">0000000000400efc &lt;phase_2&gt;:</span><br><span class="line">  400efc:	55                   	push   %rbp</span><br><span class="line">  400efd:	53                   	push   %rbx</span><br><span class="line">  400efe:	48 83 ec 28          	sub    <span class="variable">$0x28</span>,%rsp</span><br><span class="line">  400f02:	48 89 e6             	mov    %rsp,%rsi</span><br><span class="line">  400f05:	e8 52 05 00 00       	call   40145c &lt;read_six_numbers&gt;</span><br><span class="line">  400f0a:	83 3c 24 01          	cmpl   <span class="variable">$0x1</span>,(%rsp)</span><br><span class="line">  400f0e:	74 20                	je     400f30 &lt;phase_2+0x34&gt;</span><br><span class="line">  400f10:	e8 25 05 00 00       	call   40143a &lt;explode_bomb&gt;</span><br><span class="line">  400f15:	eb 19                	jmp    400f30 &lt;phase_2+0x34&gt;</span><br><span class="line">  400f17:	8b 43 <span class="built_in">fc</span>             	mov    -0x4(%rbx),%eax</span><br><span class="line">  400f1a:	01 c0                	add    %eax,%eax</span><br><span class="line">  400f1c:	39 03                	cmp    %eax,(%rbx)</span><br><span class="line">  400f1e:	74 05                	je     400f25 &lt;phase_2+0x29&gt;</span><br><span class="line">  400f20:	e8 15 05 00 00       	call   40143a &lt;explode_bomb&gt;</span><br><span class="line">  400f25:	48 83 c3 04          	add    <span class="variable">$0x4</span>,%rbx</span><br><span class="line">  400f29:	48 39 eb             	cmp    %rbp,%rbx</span><br><span class="line">  400f2c:	75 e9                	jne    400f17 &lt;phase_2+0x1b&gt;</span><br><span class="line">  400f2e:	eb 0c                	jmp    400f3c &lt;phase_2+0x40&gt;</span><br><span class="line">  400f30:	48 8d 5c 24 04       	lea    0x4(%rsp),%rbx</span><br><span class="line">  400f35:	48 8d 6c 24 18       	lea    0x18(%rsp),%rbp</span><br><span class="line">  400f3a:	eb db                	jmp    400f17 &lt;phase_2+0x1b&gt;</span><br><span class="line">  400f3c:	48 83 c4 28          	add    <span class="variable">$0x28</span>,%rsp</span><br><span class="line">  400f40:	5b                   	pop    %rbx</span><br><span class="line">  400f41:	5d                   	pop    %rbp</span><br><span class="line">  400f42:	c3                   	ret    </span><br></pre></td></tr></table></figure>
<p>为了使得汇编代码可读性更好，我们可以一步一步对其进行转换【参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_38537503/article/details/117199006">(48条消息) CSAPP实验之Bomb Lab详解_良晨的博客-CSDN博客_csapp bomblab</a>】<br>phase_2可以转换成以下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">phase_2(rdi)</span><br><span class="line">&#123;</span><br><span class="line">	rsi = rsp;</span><br><span class="line">	callq read_six_number;</span><br><span class="line">	<span class="keyword">if</span> (*rsp == 1)</span><br><span class="line">		goto 400f30;</span><br><span class="line">	<span class="keyword">else</span> </span><br><span class="line">		callq explode_bomb;</span><br><span class="line">	goto 400f30;</span><br><span class="line">400f17:</span><br><span class="line">	eax = *(rbx-4);</span><br><span class="line">	eax += eax;</span><br><span class="line">	<span class="keyword">if</span> (eax == *rbx)</span><br><span class="line">		goto 400f25;</span><br><span class="line">	<span class="keyword">else</span> </span><br><span class="line">		callq explode_bomb;</span><br><span class="line">400f25:</span><br><span class="line">	rbx += 4;			<span class="comment"># 下一个元素</span></span><br><span class="line">	<span class="keyword">if</span> (rbx != rbp)</span><br><span class="line">		goto 400f17;	<span class="comment"># 循环</span></span><br><span class="line">	<span class="keyword">else</span> </span><br><span class="line">		goto 400f3c;</span><br><span class="line">400f30:</span><br><span class="line">	rbx = rsp + 4;		<span class="comment"># 初始化 init</span></span><br><span class="line">	rbp = rsp + 24;		<span class="comment"># 数组结束</span></span><br><span class="line">	goto 400f17;</span><br><span class="line">400f3c:</span><br><span class="line">	retq</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在进一步分析代码前，我们需要弄明白read_six_number的含义，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">000000000040145c &lt;read_six_numbers&gt;:</span><br><span class="line">  40145c:	48 83 ec 18          	sub    <span class="variable">$0x18</span>,%rsp</span><br><span class="line">  401460:	48 89 f2             	mov    %rsi,%rdx</span><br><span class="line">  401463:	48 8d 4e 04          	lea    0x4(%rsi),%rcx</span><br><span class="line">  401467:	48 8d 46 14          	lea    0x14(%rsi),%rax</span><br><span class="line">  40146b:	48 89 44 24 08       	mov    %rax,0x8(%rsp)</span><br><span class="line">  401470:	48 8d 46 10          	lea    0x10(%rsi),%rax</span><br><span class="line">  401474:	48 89 04 24          	mov    %rax,(%rsp)</span><br><span class="line">  401478:	4c 8d 4e 0c          	lea    0xc(%rsi),%r9</span><br><span class="line">  40147c:	4c 8d 46 08          	lea    0x8(%rsi),%r8</span><br><span class="line">  401480:	be c3 25 40 00       	mov    <span class="variable">$0x4025c3</span>,%esi</span><br><span class="line">  401485:	b8 00 00 00 00       	mov    <span class="variable">$0x0</span>,%eax</span><br><span class="line">  40148a:	e8 61 f7 ff ff       	call   400bf0 &lt;__isoc99_sscanf@plt&gt;</span><br><span class="line">  40148f:	83 f8 05             	cmp    <span class="variable">$0x5</span>,%eax</span><br><span class="line">  401492:	7f 05                	jg     401499 &lt;read_six_numbers+0x3d&gt;</span><br><span class="line">  401494:	e8 a1 ff ff ff       	call   40143a &lt;explode_bomb&gt;</span><br><span class="line">  401499:	48 83 c4 18          	add    <span class="variable">$0x18</span>,%rsp</span><br><span class="line">  40149d:	c3                   	ret    </span><br></pre></td></tr></table></figure>
<p>这里涉及了好多寄存器，还有一个sscanf的函数调用。<br>不知道为什么sscanf的输入需要分析0x4025c3。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/s 0x4025c3</span><br><span class="line">0x4025c3:	&quot;%d %d %d %d %d %d&quot;</span><br></pre></td></tr></table></figure>
<p>下图展示了read_six_numbers所需的6个参数的分布： 用’1st’表示第一个参数，并以此类推<br><img src="20230102223830.png"></p>
<p>因此，read_six_number的作用是把字符串转为6个数字，并存储在整数数组中。<br>即rsp 到 rsp + 0x18 ，以0x04为分隔。<br>再回到phase_2上，可以进一步转换，让它更像c的风格：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">phase_2(edi)</span><br><span class="line">&#123;</span><br><span class="line">	rsi = rsp;</span><br><span class="line">	read_six_number(rdi, rsi);</span><br><span class="line">	<span class="keyword">if</span> (*rsp != <span class="number">1</span>)</span><br><span class="line">		explode_bomb();</span><br><span class="line">	rbx = rsp + <span class="number">4</span>;</span><br><span class="line">	rbp = rsp + <span class="number">24</span>;</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		eax = *(rbx<span class="number">-4</span>);</span><br><span class="line">		eax += eax;</span><br><span class="line">		<span class="keyword">if</span> (eax != *rbx)</span><br><span class="line">			explode_bomb();</span><br><span class="line">		rbx += <span class="number">4</span>;</span><br><span class="line">	&#125; <span class="keyword">while</span>(rbx != rbp);</span><br><span class="line">	retq;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从这里我们可以比较明确地看出phase_2所表达的意思：即读入字符串并解析，然后通过循环对数组的每个元素进行判断处理。<br>因此，我们可以再对以上代码进行整理：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">phase_2</span><span class="params">(<span class="type">char</span>* output)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> <span class="built_in">array</span>[<span class="number">6</span>];</span><br><span class="line">    read_six_numbers(output, <span class="built_in">array</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">array</span>[<span class="number">0</span>] != <span class="number">1</span>)    </span><br><span class="line">    	explode_bomb();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; <span class="number">6</span>; i++) &#123;</span><br><span class="line">        <span class="built_in">array</span>[i<span class="number">-1</span>] += <span class="built_in">array</span>[i<span class="number">-1</span>];</span><br><span class="line">    	<span class="keyword">if</span> (<span class="built_in">array</span>[i] != <span class="built_in">array</span>[i<span class="number">-1</span>])</span><br><span class="line">            explode_bomb();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从以上代码已经可以清晰看出，phase_2的功能：</p>
<ul>
<li>将输入的字符串解析为6个数字，并将其存为整数数组array</li>
<li>array的第一个整数必须为1</li>
<li>array中每个元素必须是前一个元素的两倍<br>因此，答案已经很明朗了，是以1为首个元素的，以2为比的等比数列：<br>1 2 4 8 16 32<br>phase_2通过！<br><img src="20230103134058.png"><h3 id="phase-3"><a href="#phase-3" class="headerlink" title="phase_3"></a>phase_3</h3>和第二关同样的思路，首先让我们先尝试将汇编语言转换成类c语言<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">rcx = rsp + 12;</span><br><span class="line">rdx = rsp + 8;</span><br><span class="line">esi = 0x4025cf; <span class="comment"># 0x4025cf is &quot;%d %d&quot;</span></span><br><span class="line">eax = 0x0;</span><br><span class="line">call sscanf(rdi, esi, rdx, rcx);</span><br><span class="line"><span class="keyword">if</span> (eax - 1 &gt; 0) &#123;</span><br><span class="line">	<span class="keyword">if</span> (*(rsp + 8) - 7 &gt; 0) &#123;</span><br><span class="line">		explode_bomb();</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		eax = *(rsp + 8);</span><br><span class="line">		goto *(8*rax + 0x402470);</span><br><span class="line">	&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	explode_bomb();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">400f7c:</span><br><span class="line">	eax = 0xcf;</span><br><span class="line">	goto 400fbe;</span><br><span class="line">400f83:</span><br><span class="line">	eax = 0x2c3;</span><br><span class="line">	goto 400fbe;</span><br><span class="line">400f8a:</span><br><span class="line">	eax = 0x100;</span><br><span class="line">	goto 400fbe;</span><br><span class="line">400f91:</span><br><span class="line">	eax = 0x185;</span><br><span class="line">	goto 400fbe;</span><br><span class="line">400f98:</span><br><span class="line">	eax = 0xce;</span><br><span class="line">	goto 400fbe;</span><br><span class="line">400f9f:</span><br><span class="line">	eax = 0x2aa;</span><br><span class="line">	goto 400fbe;</span><br><span class="line">400fa6:</span><br><span class="line">	eax = 0x147;</span><br><span class="line">	goto 400fbe;</span><br><span class="line">400fb2:</span><br><span class="line">	eax = 0x0;</span><br><span class="line">	goto 400fbe;</span><br><span class="line">400fb9:</span><br><span class="line">	eax = 0x137;</span><br><span class="line"></span><br><span class="line">400fbe:</span><br><span class="line">	<span class="keyword">if</span> (eax - *(rsp + 0xc) == 0) &#123;</span><br><span class="line">		rsp += 0x18; // 回退栈指针</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		explode_bomb();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
首先，phase_3里同样有一个sscanf()的函数，通过gdb的调试可以看出其格式为“%d %d”，由此可以推断其需要两个数字。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/s 0x4025cf</span><br><span class="line">0x4025cf:	&quot;%d %d&quot;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>之后，从 * (8 * %rax + 0x402470); 这一句可以看出，0x402470应该是一个跳表的地址，而%rax的值为(%rsp + 8)，即输入的第一个参数。【<strong>有一点不是很明白，这里输入的第一个参数%rsp +8, 输入的第二个参数是%rsp + 12</strong>】</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/16a 0x402470</span><br><span class="line">0x402470:       0x400f7c &lt;phase_3+57&gt;   0x400fb9 &lt;phase_3+118&gt;</span><br><span class="line">0x402480:       0x400f83 &lt;phase_3+64&gt;   0x400f8a &lt;phase_3+71&gt;</span><br><span class="line">0x402490:       0x400f91 &lt;phase_3+78&gt;   0x400f98 &lt;phase_3+85&gt;</span><br><span class="line">0x4024a0:       0x400f9f &lt;phase_3+92&gt;   0x400fa6 &lt;phase_3+99&gt;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>index</th>
<th>0</th>
<th>1</th>
<th>2</th>
<th>3</th>
<th>4</th>
<th>5</th>
<th>6</th>
<th>7</th>
</tr>
</thead>
<tbody><tr>
<td>address</td>
<td>0x400f7c</td>
<td>0x400fb9</td>
<td>0x400f83</td>
<td>0x400f8a</td>
<td>0x400f91</td>
<td>0x400f98</td>
<td>0x400f9f</td>
<td>0x400fa6</td>
</tr>
<tr>
<td>%eax</td>
<td>207</td>
<td>311</td>
<td>707</td>
<td>256</td>
<td>389</td>
<td>206</td>
<td>682</td>
<td>327</td>
</tr>
</tbody></table>
<p>将phase_3转换成c代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">phase_3</span><span class="params">(<span class="type">char</span>* output)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> x, y;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">sscanf</span>(output, <span class="string">&quot;%d %d&quot;</span>, &amp;x, &amp;y) &lt;= <span class="number">1</span>)</span><br><span class="line">        explode_bomb();</span><br><span class="line">    <span class="keyword">if</span>(x &gt; <span class="number">7</span>)</span><br><span class="line">        explode_bomb();</span><br><span class="line">    <span class="type">int</span> num;</span><br><span class="line">    <span class="keyword">switch</span>(x) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        num = <span class="number">207</span>;</span><br><span class="line">    	<span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        num = <span class="number">311</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        num = <span class="number">707</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        num = <span class="number">256</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        num = <span class="number">389</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">        num = <span class="number">206</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">        num = <span class="number">682</span>;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">        num = <span class="number">327</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (num != y)</span><br><span class="line">        explode_bomb();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过分析，phase_3的功能如下：</p>
<ul>
<li><p>将字符串解析为两个数字x、y</p>
</li>
<li><p>x不能大于7</p>
</li>
<li><p>通过switch-case将x的值映射为一个num值</p>
</li>
<li><p>y必须等于num<br>因此答案有多个：</p>
</li>
<li><p>0 207</p>
</li>
<li><p>1 311</p>
</li>
<li><p>2 707</p>
</li>
<li><p>3 256</p>
</li>
<li><p>4 389</p>
</li>
<li><p>5 206</p>
</li>
<li><p>6 682</p>
</li>
<li><p>7 327<br>由于总共有6关，每一关都需要输入一次参数，如果每次都重新输入，势必是麻烦的，因此，可以将每次结果存入ans.txt中，然后在gdb中运行r ans.txt即可。</p>
</li>
</ul>
<p>第三关通过！<br><img src="20230103161313.png"></p>
<h3 id="phase-4"><a href="#phase-4" class="headerlink" title="phase_4"></a>phase_4</h3><p>首先，依照之前的解题思路，还是先将汇编语言进行整理：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">rcx = rsp + 0xc;</span><br><span class="line">rdx = rsp + 8;</span><br><span class="line">esi = 0x4025cf;// 由上题可知，这里仍是要求2个输入</span><br><span class="line">eax = 0;</span><br><span class="line">sscanf(rdi, esi, rdx, rcx);</span><br><span class="line"><span class="keyword">if</span> (eax != 2) &#123; <span class="comment"># 要求输入必须为2个整数</span></span><br><span class="line">	explode_bomb();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> (*(rsp + 8) - 0xe &lt;= 0) &#123; <span class="comment">#第一个参数必须小于0xe 即14</span></span><br><span class="line">		edx = 0xe;</span><br><span class="line">		esi = 0;</span><br><span class="line">		edi = *(rsp + 8);</span><br><span class="line">		func4(rdi, esi, rdx);</span><br><span class="line">		<span class="keyword">if</span> (eax != 0) &#123;</span><br><span class="line">			explode_bomb();</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (*(rsp + 0xc) != 0) &#123;</span><br><span class="line">				explode_bomb();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		explode_bomb();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func4(rdi, esi, rdx) &#123;</span><br><span class="line">	eax = edx;</span><br><span class="line">	eax -= esi;</span><br><span class="line">	ecx = eax;</span><br><span class="line">	ecx &gt;&gt;= 31; <span class="comment"># logical right shift</span></span><br><span class="line">	eax += ecx;</span><br><span class="line">	eax &gt;&gt;= 1; <span class="comment"># amthetic right shift</span></span><br><span class="line">	ecx = rsi + rax;</span><br><span class="line">	<span class="keyword">if</span> (ecx - edi &gt; 0) &#123;</span><br><span class="line">		edx = rcx - 1;</span><br><span class="line">		goto func4(rdi, esi, rdx);</span><br><span class="line">		eax += eax;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		eax = 0;</span><br><span class="line">		<span class="keyword">if</span> (ecx - edi &lt; 0) &#123;</span><br><span class="line">			esi = rcx + 1;</span><br><span class="line">			goto func4(rdi, esi, rdx);</span><br><span class="line">			eax = rax + rax + 1;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了更加清晰，我们将一些寄存器和内存存储转换成变量进行表达。<br>这是phase_4()：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">phase_4</span><span class="params">(<span class="type">char</span>* input)</span> &#123;</span><br><span class="line">	<span class="type">int</span> x, y;</span><br><span class="line">	<span class="type">int</span> ret = <span class="built_in">sscanf</span>(input, <span class="string">&quot;%d %d&quot;</span>, &amp;x, &amp;y);<span class="comment">// 从这一句我们也基本可以知道几个变量的存储方式</span></span><br><span class="line">	<span class="keyword">if</span> (ret != <span class="number">2</span> || x &gt; <span class="number">14</span>) &#123;</span><br><span class="line">		explode_bomb();</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="type">int</span> ans = func4(x, <span class="number">0</span>, <span class="number">14</span>);</span><br><span class="line">		<span class="keyword">if</span> (ans != <span class="number">0</span> || y != <span class="number">0</span>) &#123;</span><br><span class="line">			explode_bomb();</span><br><span class="line">		&#125;	</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于func4比较复杂，我们先将其做初步简化：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">func4(edi, esi, edx) &#123;</span><br><span class="line">	eax = edx - esi;</span><br><span class="line">	eax = (eax + eax &gt;&gt; 31) &gt;&gt; 1;</span><br><span class="line">	ecx = rax + rsi;</span><br><span class="line">	<span class="keyword">if</span> (ecx &lt;= edi) &#123;</span><br><span class="line">		eax = 0;</span><br><span class="line">		<span class="keyword">if</span> (ecx &gt;= edi) &#123;</span><br><span class="line">			<span class="built_in">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		esi = rcx + 1;</span><br><span class="line">		rax = func4(edi, esi, edx);</span><br><span class="line">		eax = 2 * rax + 1;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		edx = rcx - 1;</span><br><span class="line">		rax = func4(edi, esi, edx);</span><br><span class="line">		eax = 2 * rax;</span><br><span class="line">	&#125;</span><br><span class="line">	retq;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由以上代码可以看出，func4是一个递归函数，且有两个分支，ecx &lt;= edi 和 ecx &gt; edi。<br>第一个分支，esi = rcx + 1，然后递归；第二个分支，edx = rcx - 1,然后递归。<br>这是func4()进一步简化成c的代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">func4</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line">	<span class="type">int</span> num = b - a;</span><br><span class="line">	num = (num + num &gt;&gt; <span class="number">31</span>) / <span class="number">2</span>;</span><br><span class="line">	<span class="type">int</span> c = num + a;</span><br><span class="line">	<span class="keyword">if</span> (c &lt;= x) &#123;</span><br><span class="line">		<span class="keyword">if</span> (c &gt;= x) <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// 这里其实相当于c == x</span></span><br><span class="line">		<span class="keyword">return</span> <span class="number">2</span> * func4(x, c + <span class="number">1</span>, b) + <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">2</span> * func4(x, a, c - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>经过分析，func4其实可以看做是一种二分法的变体。<br>(num + num &gt;&gt; 31) / 2 这一行，只有在num &lt; 0 时， 才会转换为(num + 1) / 2，当num &gt;= 0时，由于num &gt;&gt; 31 结果为0 ，这一行相当于 num / 2。<br>因此，c = (b - a) / 2 + a;[b - a &gt;= 0] c = (b - a + 1) / 2 + a;[b - a &lt; 0]<br>分支的情况，即 c = x时，返回0，c &lt; x 返回 奇数， c &gt; x 返回偶数。<br>因为c &lt; x时，会使结果 &gt; 0，必定会爆炸，所以c 必须 ≤ x。而且最后都得让x被找到，让结果返回0。<br>因此我们计算每一轮c的值，即可得到x。<br>经计算，c可以为7，3，1，0。即x可以为7,3,1,0。而y必须为0。<br>因此答案可以为：</p>
<ul>
<li><p>7 0</p>
</li>
<li><p>3 0</p>
</li>
<li><p>1 0</p>
</li>
<li><p>0 0</p>
</li>
</ul>
<p>这一关也通过啦！<br><img src="20230104150012.png"></p>
<h3 id="phase-5"><a href="#phase-5" class="headerlink" title="phase_5"></a>phase_5</h3><p>还是一样的思路，先将汇编转换：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">rbx = rdi;</span><br><span class="line">rax = fs:0x28;</span><br><span class="line"></span><br><span class="line">*(rsp + 0x18) = rax;</span><br><span class="line">eax = eax ^ eax; </span><br><span class="line">string_length(rdi);  <span class="comment"># 计算字符串长度</span></span><br><span class="line"><span class="keyword">if</span> (eax - 6 == 0) &#123;</span><br><span class="line">	goto 4010d2;</span><br><span class="line">&#125; <span class="keyword">else</span> call explode_bomb();</span><br><span class="line">goto 4010d2;</span><br><span class="line"></span><br><span class="line">40108b:</span><br><span class="line">	ecx = *(rax + rbx);</span><br><span class="line">	*rsp = cl;</span><br><span class="line">	rdx = *rsp;</span><br><span class="line">	edx = edx &amp; f;</span><br><span class="line">	edx = *(rdx + 0x4024b0);</span><br><span class="line">	*(rax + rsp + 16) = dl;</span><br><span class="line">	rax = rax + 1;  <span class="comment">#自增</span></span><br><span class="line">	<span class="keyword">if</span> (rax - 6 != 0) &#123; <span class="comment"># 循环测试条件</span></span><br><span class="line">		goto 40108b;</span><br><span class="line">	&#125;</span><br><span class="line">	*(rsp + 0x16) = 0;</span><br><span class="line">	esi = 0x40245e;</span><br><span class="line">	rdi = rsp + 0x10;</span><br><span class="line">	strings_not_equal(rdi,rsi);</span><br><span class="line">	<span class="keyword">if</span> (eax != 0) &#123;</span><br><span class="line">		explode_bomb();</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		goto 4010d9;	</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">4010d2:</span><br><span class="line">	eax = 0; <span class="comment">#init</span></span><br><span class="line">	goto 40108b;</span><br><span class="line"></span><br><span class="line">4010d9:</span><br><span class="line">	rax = *(rsp + 0x18);</span><br><span class="line">	rax = rax ^ fs:0x28;</span><br><span class="line">	<span class="keyword">if</span> (rax == 0) &#123; <span class="comment"># 栈是否被破坏</span></span><br><span class="line">		goto 4010ee;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		callq __stack_chl_fail@plt;</span><br><span class="line">	&#125;</span><br><span class="line">4010ee:</span><br><span class="line">	ret;</span><br></pre></td></tr></table></figure>
<p>上面的代码有点冗长了，我们将他整理地更像c一些:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">phase_5(rdi) &#123;</span><br><span class="line">	rbx = rdi;</span><br><span class="line">	eax = eax ^ eax;</span><br><span class="line">	eax = string_length(rdi);</span><br><span class="line">	<span class="keyword">if</span> (eax != <span class="number">6</span>) &#123;</span><br><span class="line">		explode_bomb();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (eax = <span class="number">0</span>; eax != <span class="number">6</span>; eax++) &#123;</span><br><span class="line">		ecx = rbx + rax;</span><br><span class="line">		*rsp = cl;</span><br><span class="line">		rdx = *rsp;</span><br><span class="line">		edx = edx &amp; <span class="number">0xf</span>;</span><br><span class="line">		edx = *(rdx + <span class="number">0x4024b0</span>);</span><br><span class="line">		*(rsp + rax + <span class="number">0x10</span>) = dl;</span><br><span class="line">	&#125;</span><br><span class="line">	*(rsp + <span class="number">0x16</span>) == <span class="number">0</span>;</span><br><span class="line">	esi = <span class="number">0x40245e</span>;</span><br><span class="line">	rdi = rsp + <span class="number">0x10</span>;</span><br><span class="line">	strings_not_equal(rdi, rsi);</span><br><span class="line">	<span class="keyword">if</span> (eax != <span class="number">0</span>) &#123;</span><br><span class="line">		explode_bomb();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查看0x4024b0的值为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) print (char *) 0x4024b0</span><br><span class="line">$1 = 0x4024b0 &lt;array&gt; &quot;maduiersnfotvbylSo you think you can stop the bomb with ctrl-c, do you?&quot;</span><br></pre></td></tr></table></figure>
<p>从打印出来的值，可以看出0x4024b0这个地址对应的是一段字符数组<br>查看0x40245e的值为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) 0x40245e</span><br><span class="line">0x40245e:       &quot;flyers&quot;</span><br></pre></td></tr></table></figure>

<p>让我们再将注意力放在循环体内：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 取输入字符串的rax位置的字符</span><br><span class="line">ecx = rbx + rax;</span><br><span class="line">*rsp = cl;</span><br><span class="line">rdx = *rsp;</span><br><span class="line"># 让取出的字符和<span class="number">0xf</span>与操作 意味着取<span class="number">0</span><span class="number">-15</span>的值</span><br><span class="line">edx = edx &amp; <span class="number">0xf</span>;</span><br><span class="line"># 取<span class="number">0x4024b0</span>数组edx位置的值</span><br><span class="line">edx = *(rdx + <span class="number">0x4024b0</span>);</span><br><span class="line"># 在栈中依次存入edx的结果，相当于存了一个字符数组</span><br><span class="line">*(rsp + rax + <span class="number">0x10</span>) = dl;</span><br></pre></td></tr></table></figure>

<p> * ( rdx + 0x4024b0) 的操作可以得到0x4024b0的前16个字符，即：maduiersnfotvbyl<br> * (rsp + 0x16) == 0; 这一行代码，相当于是给rsp开出的字符串进行结尾<br> 下面这段代码揭示了，我们需要比较rsp + 0x10 - rsp + 0x16的字符串和”flyers”是否相等<br> <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">esi = <span class="number">0x40245e</span>;</span><br><span class="line">rdi = rsp + <span class="number">0x10</span>;</span><br><span class="line">strngs_not_equal(rdi, rsi);</span><br><span class="line"><span class="keyword">if</span> (eax != <span class="number">0</span>) &#123;</span><br><span class="line">	explode_bomb();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>为了让整个过程更清晰，可以将整个代码翻译成c语言，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">char</span> g_str[<span class="number">16</span>] = <span class="string">&quot;maduiersnfotvbyl&quot;</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">phase_5</span><span class="params">(<span class="type">char</span>* input)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> str[<span class="number">7</span>];</span><br><span class="line">	<span class="keyword">if</span> (string_length(input) != <span class="number">6</span>) &#123;</span><br><span class="line">		explode_bomb();</span><br><span class="line">	&#125;</span><br><span class="line">        <span class="comment">// 9 15 14 5 6 7</span></span><br><span class="line">    	<span class="comment">// I O N E F G</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i != <span class="number">6</span>; i++) &#123;</span><br><span class="line">        str[i] = g_str[input[i] &amp; <span class="number">0xf</span>];</span><br><span class="line">	&#125;</span><br><span class="line">    str[<span class="number">7</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span>(string_not_equal(str, <span class="string">&quot;flyers&quot;</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">        explode_bomb();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此，相当于我们要从“maduiersnfotvbyl”里依次找出“flyers”各个字符对应的序号。<br>分别为9 15 14 5 6 7，然后需要我们查找ascii表，找到c &amp; 0xf 分别为9 15 14 5 6 7 的字符，<br>因为我们只取了输入的每一个字符的后4位ASCLl码当作索引值。也就是说所有后四位满足上面要求的字符都可。这里我们随便取一组。我们可以对上面的值。都加上64，这样不会改变后4位的位模式。并且还能得到简单的结果<br>73=I 79=O 78=N 69=E 70=F 77=G<br>结果为：<br>IONEFG<br>第五关也通过啦！<br><img src="20230105222443.png"></p>
<h3 id="phase-6"><a href="#phase-6" class="headerlink" title="phase_6"></a>phase_6</h3><p>首先还是按照之前的思路将汇编语言一步一步转换成c代码 这题代码巨长，需要慢慢分析<br>首先是梳理汇编语言：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">r13 = rsp;</span><br><span class="line">rsi = rsp;</span><br><span class="line">read_six_numbers();</span><br><span class="line">r14 = rsp;</span><br><span class="line">r12d = 0;  <span class="comment"># i = 0</span></span><br><span class="line">401114:</span><br><span class="line">	rbp = r13;</span><br><span class="line">	eax = *(r13 + 0);</span><br><span class="line">	eax -= 1;</span><br><span class="line">	<span class="keyword">if</span> (eax - 5 &lt;= 0) &#123;</span><br><span class="line">		goto 401128;</span><br><span class="line">	&#125; <span class="keyword">else</span> explode_bomb();</span><br><span class="line"></span><br><span class="line">401128:</span><br><span class="line">	r12d += 1; <span class="comment"># i++</span></span><br><span class="line">	<span class="keyword">if</span> (r12d == 6) &#123;</span><br><span class="line">		goto 401153;  <span class="comment"># 外层跳出循环</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		ebx = r12d;   <span class="comment"># j = i;</span></span><br><span class="line">401135:</span><br><span class="line">		rax = ebx;     </span><br><span class="line">		eax = *(4 * rax + rsp);</span><br><span class="line">		<span class="keyword">if</span> (*(rbp) != eax) &#123;</span><br><span class="line">			goto 401145;</span><br><span class="line">		&#125; <span class="keyword">else</span> explode_bomb();</span><br><span class="line">	&#125;</span><br><span class="line">401145:</span><br><span class="line">	ebx += 1;          <span class="comment"># j++</span></span><br><span class="line">	<span class="keyword">if</span> (ebx - 5 &lt;= 0) &#123; <span class="comment"># 内层循环退出条件</span></span><br><span class="line">		goto 401135; <span class="comment"># 内层循环</span></span><br><span class="line">	&#125;</span><br><span class="line">	r13 += 4;</span><br><span class="line">	goto 401114;     <span class="comment"># 外层循环</span></span><br><span class="line">-----------------------------</span><br><span class="line">401153:</span><br><span class="line">	rsi = rsp + 0x18;</span><br><span class="line">	rax = r14;       <span class="comment"># i = r14</span></span><br><span class="line">	ecx = 7;</span><br><span class="line">4001160:</span><br><span class="line">	edx = ecx;</span><br><span class="line">	edx -= *(rax);</span><br><span class="line">	*(rax) = edx;</span><br><span class="line">	rax += 4;        <span class="comment"># i += 4</span></span><br><span class="line">	<span class="keyword">if</span> (rax != rsi) &#123;   <span class="comment"># 循环退出条件</span></span><br><span class="line">		goto 401160;</span><br><span class="line">	&#125;</span><br><span class="line">	esi = 0;            <span class="comment"># i = 0</span></span><br><span class="line">	goto 401197;</span><br><span class="line">401176:</span><br><span class="line">	rdx = *(rdx + 8);</span><br><span class="line">	eax += 1;           <span class="comment"># j++</span></span><br><span class="line">	<span class="keyword">if</span> (eax != ecx) &#123;   <span class="comment"># 内存循环退出条件</span></span><br><span class="line">		goto 401176;</span><br><span class="line">	&#125;</span><br><span class="line">	goto 401188;</span><br><span class="line">401183:</span><br><span class="line">	edx = 0x6032d0;</span><br><span class="line">401188:</span><br><span class="line">	*(2 * rsi + rsp + 0x20) = rdx;</span><br><span class="line">	rsi += 4;           <span class="comment"># i += 4</span></span><br><span class="line">	<span class="keyword">if</span> (rsi == 0x18) &#123;  <span class="comment"># 外层循环退出条件</span></span><br><span class="line">		goto 4011ab;</span><br><span class="line">	&#125; </span><br><span class="line">401197:</span><br><span class="line">	ecx = *(rsi + rsp);</span><br><span class="line">	<span class="keyword">if</span> (ecx - 0x1 &lt;= 0) &#123;</span><br><span class="line">		goto 401183;</span><br><span class="line">	&#125; </span><br><span class="line">	eax = 1;             <span class="comment"># j = 1</span></span><br><span class="line">	edx = 0x6032d0;</span><br><span class="line">	goto 401176;</span><br><span class="line">------------------------</span><br><span class="line">4011ab:</span><br><span class="line">	rbx = *(rsp + 0x20);</span><br><span class="line">	rax = *(rsp + 0x28);       <span class="comment"># i = *(rsp + 0x28)</span></span><br><span class="line">	rsi = *(rsp + 0x50);</span><br><span class="line">	rcx = rbx;</span><br><span class="line">4011bd:</span><br><span class="line">	rdx = *(rax);</span><br><span class="line">	*(rcx + 8) = rdx;</span><br><span class="line">	rax += 8;             <span class="comment"># i += 8</span></span><br><span class="line">	<span class="keyword">if</span> (rax == rsi) &#123;     <span class="comment"># 循环退出条件</span></span><br><span class="line">		goto 4011d2;</span><br><span class="line">	&#125;</span><br><span class="line">	rcx = rdx;</span><br><span class="line">	goto 4011bd;</span><br><span class="line">------------------------</span><br><span class="line">4011d2:</span><br><span class="line">	*(rdx + 8) = 0;</span><br><span class="line">	ebp = 5;              <span class="comment"># i = 5</span></span><br><span class="line">	rax = *(rbx + 8);</span><br><span class="line">	ebp = 5;</span><br><span class="line">4011df:</span><br><span class="line">	rax = *(rbx + 8);</span><br><span class="line">	eax = *(rax);</span><br><span class="line">	<span class="keyword">if</span> ( *(rbx) &gt;= eax) &#123;</span><br><span class="line">		goto 4011ee;</span><br><span class="line">	&#125; <span class="keyword">else</span> explode_bomb();</span><br><span class="line">4011ee:</span><br><span class="line">	rbx = *(rbx + 8);</span><br><span class="line">	ebp -=1;              <span class="comment"># i--</span></span><br><span class="line">	<span class="keyword">if</span> (ebp != 0)&#123;        <span class="comment"># 循环退出条件</span></span><br><span class="line">		goto 4011df;</span><br><span class="line">	&#125;</span><br><span class="line">	ret;</span><br></pre></td></tr></table></figure>

<p>在read_six_numbers前，发现和第二关比较相似：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">第一个参数 m[%rsp]    设为a1</span><br><span class="line">第二个参数 m[%<span class="number">4</span>+rsp]  设为a2</span><br><span class="line">第三个参数 m[%<span class="number">8</span>+rsp]  设为a3</span><br><span class="line">第四个参数 m[%c+rsp]  设为a4</span><br><span class="line">第五个参数 m[%<span class="number">10</span>+rsp] 设为a5</span><br><span class="line">第六个参数 m[%<span class="number">14</span>+rsp] 设为a6 </span><br></pre></td></tr></table></figure>

<p>通过以上的梳理，我们大致可以分出5个部分，分别是5个循环，其中第一个和第三个是双重循环。<br>分析完整体的逻辑，我们可以进一步将上面的代码进行转换，让他更像C一点：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">phase_6(rdi) &#123;</span><br><span class="line">	r13 = rsp;  </span><br><span class="line">	rsi = rsp;  </span><br><span class="line">	read_six_numbers(rdi,rsi);</span><br><span class="line">	r14 = rsp;  </span><br><span class="line">	<span class="keyword">for</span> (r12 = <span class="number">0</span>; r12 = <span class="number">6</span>; r12++) &#123;</span><br><span class="line">		rbp = r13;  </span><br><span class="line">		eax = *r13; <span class="comment">// eax = a1</span></span><br><span class="line">		eax -= <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">if</span> (eax &gt; <span class="number">5</span>) &#123; <span class="comment">//说明a1 &lt;= 6</span></span><br><span class="line">			explode_bomb();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> (ebx = r12 + <span class="number">1</span>; ebx &lt;= <span class="number">5</span>; ebx++) &#123;</span><br><span class="line">			rax = ebx;</span><br><span class="line">			eax = *(rsp + rax * <span class="number">4</span>);  <span class="comment">// eax = m[rsp + 4 * rax] 相当于是遍历a2 - a5</span></span><br><span class="line">			<span class="keyword">if</span> (*rbp == eax) explode_bomb();  <span class="comment">// *rbp == a1 - a5 所以这句话的意思是6个参数不能相等</span></span><br><span class="line">		&#125;</span><br><span class="line">		r13 += <span class="number">4</span>;  <span class="comment">// rsp + 4i</span></span><br><span class="line">	&#125;</span><br><span class="line">	rsi = rsp + <span class="number">0x18</span>;  <span class="comment">//设置了边界</span></span><br><span class="line">	rax = r14; <span class="comment">// rsp</span></span><br><span class="line">	ecx = <span class="number">7</span>;</span><br><span class="line">	<span class="keyword">for</span> (rax = r14; rax !=rsi; rax += <span class="number">4</span>) &#123;</span><br><span class="line">		edx = ecx; <span class="comment">// rdx = 7</span></span><br><span class="line">		edx -= *rax; <span class="comment">// edx = 7 - ai</span></span><br><span class="line">		*rax = edx; <span class="comment">// ai = 7 - ai</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (rsi = <span class="number">0</span>; rsi != <span class="number">0x18</span>; rsi += <span class="number">4</span>) &#123;</span><br><span class="line">		ecx = *(rsp + rsi); <span class="comment">//ecx = m[rsp + 4i] = ai</span></span><br><span class="line">		<span class="keyword">if</span> (ecx &gt;= <span class="number">1</span>) edx = <span class="number">0x6032d0</span>;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			edx = <span class="number">0x6032d0</span>;</span><br><span class="line">			<span class="keyword">for</span> (eax = <span class="number">1</span>; eax != ecx; eax++) &#123;</span><br><span class="line">				rdx = *(rdx + <span class="number">8</span>); <span class="comment">// 有点像将指针指的指针赋给当前指针 即 ptr = ptr -&gt; next 这样的操作 </span></span><br><span class="line">			&#125; <span class="comment">// 这个循环的操作，是找到与ai相匹配的序号值的指针</span></span><br><span class="line">		&#125;</span><br><span class="line">		*(rsp + <span class="number">2</span> * rsi + <span class="number">0x20</span>) = rdx; <span class="comment">// 在m[rsp + 0x20 + 2 * i] 赋予当前指针 </span></span><br><span class="line">	&#125;</span><br><span class="line">	rbx = *(rsp + <span class="number">0x20</span>); <span class="comment">// 上个循环赋予的起始指针</span></span><br><span class="line">	rcx = rbx; <span class="comment">// rcx = p1</span></span><br><span class="line">	<span class="keyword">for</span> (rax = rsp + <span class="number">0x28</span>; rax != rsp + <span class="number">0x50</span>; rax += <span class="number">8</span>) &#123;</span><br><span class="line">		rdx = *rax; <span class="comment">// rdx = pi i从2开始</span></span><br><span class="line">		*(rcx + <span class="number">8</span>) = rdx; <span class="comment">// 相当于重新将p1 - p6串起来</span></span><br><span class="line">		rcx = rdx;</span><br><span class="line">	&#125;</span><br><span class="line">	*(rdx + <span class="number">8</span>) = <span class="number">0</span>; <span class="comment">// 使得最后一个指针中的指针指向0</span></span><br><span class="line">	<span class="keyword">for</span> (ebp = <span class="number">5</span>; ebp != <span class="number">0</span>; ebp -= <span class="number">1</span>) &#123;</span><br><span class="line">		rax = *(rbx + <span class="number">0x8</span>); <span class="comment">// rax = pi</span></span><br><span class="line">		eax = *rax; <span class="comment">// eax = pi 的第一个值</span></span><br><span class="line">		<span class="keyword">if</span> (eax &gt; *(rbx)) explode_bomb(); <span class="comment">//要求链表节点的值要单调递减 </span></span><br><span class="line">		rbx = *(rbx + <span class="number">8</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到现在，整个代码的逻辑还是不太清晰，但我们大概可以知道，需要输入6个数字。</p>
<ul>
<li>第一个循环对整数数组做了一些判断，应该是要符合某种规则【即6个输入的整数不能相等，且不能大于6】</li>
<li>第二个循环修改了整数数组的值 【让ai = 7 - ai】</li>
<li>第三个循环 是构造了一个指针数组 【这个得继续往下分析】</li>
<li>第四个循环是对指针数组做了修改</li>
<li>第五个循环也得下面分析再看看</li>
</ul>
<p>我们再聚焦一下第三个循环：<br>查看0x6043d0这个地址到底是啥：<br>这里我们发现x/d x/x分别能让 x/24w输出不同的内容，一个是以10进制输出，一个是以16进制输出。<br>x/24w 0x6032d0指的是，输出从0x6032d0地址开始的24个字长的地址<br><img src="20230106174758.png"></p>
<p>单是从输出我们就可以发现，这个结构其实是一个node链表，然后有4列，第一列和第二列共占了8位，1个字节，第三列占了4个字节，那么最后一列应该也是占了1个字节。<br>每一个node的第三列，我们发现其地址是下一个node的起始地址，这里应该已经比较明显了。<br>总结起来就是每个node的节点，由4个部分组成，然后第三个属性则又是一个node指针，指向下一个结点的指针。<br>这一行的操作，就是将ai对应的序号的指针，从rsp + 0x20，依次往上存，每次占8位<br>相当于构造了一个指针组成的数组</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*(rsp + <span class="number">2</span> * rsi + <span class="number">0x20</span>) = rdx;</span><br></pre></td></tr></table></figure>

<p>第四个循环的操作相当于是将p1 - p6重新串成1个链表<br>第五个循环是要求，新组成的指针数组，其开头的值要单调递减<br>相当于是让332 168 924 691 477 443 这6个数，经重新排序后，变成单调递减<br>那么答案应该也已经出来了：<br>3 4 5 6 1 2<br>但是以上的排序是7 - ai的，因此ai的排序为：<br>4 3 2 1 6 5<br><img src="20230106185805.png"></p>
<p>终于全部通关啦！</p>
<h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h3><p>然而，在<del>抄</del>参考别人的文档时，发现原来还有隐藏关卡。<br>在bomb.c文件的最后，留下了这样一句耐人寻味的话：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/* Wow, they got it!  But isn&#x27;t something... missing?  Perhaps  </span><br><span class="line"> * something they overlooked?  Mua ha ha ha ha! */</span><br></pre></td></tr></table></figure>

<p>既然是隐藏关卡，那肯定就要找到开启这个副本的入口啦。<br>首先粗暴的方法，直接在bomb.s中，搜索secret_phase的关键词，可以发现函数phase_defused中出现了调用函数secret_phase的语句：call 401242。其中phase_defused是每关通过后都会调用的函数。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">401630:   e8 0d <span class="built_in">fc</span> ff ff          callq  401242 &lt;secret_phase&gt;</span><br></pre></td></tr></table></figure>
<p>注意以下片段：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">4015d6:   31 c0                   xor    %eax,%eax  </span><br><span class="line">4015d8:   83 3d 81 21 20 00 06    cmpl   $0x6,0x202181(%rip)        # 603760 &lt;num_input_strings&gt;  </span><br><span class="line">4015df:   75 5e                   jne    40163f &lt;phase_defused+0x7b&gt;  </span><br><span class="line">...  </span><br><span class="line">40163f:   48 8b 44 24 68          mov    0x68(%rsp),%rax  </span><br><span class="line">401644:   64 48 33 04 25 28 00    xor    %fs:0x28,%rax  </span><br><span class="line">40164b:   00 00  </span><br><span class="line">40164d:   74 05                   je     401654 &lt;phase_defused+0x90&gt;  </span><br><span class="line">40164f:   e8 dc f4 ff ff          callq  400b30 &lt;__stack_chk_fail@plt&gt;  </span><br><span class="line">401654:   48 83 c4 78             add    $0x78,%rsp  </span><br><span class="line">401658:   c3                      retq  </span><br><span class="line">401659:   90                      nop  </span><br></pre></td></tr></table></figure>
<p>4015d6: <code>xor %eax,%eax</code> 将 %eax 寄存器设置为 <code>0</code>。</p>
<p>4015d8: <code>cmpl $0x6,0x202181(%rip)</code> 和 4015df: <code>jne 40163f</code> 判断 <code>0x202181(%rip)</code> 的值是否为 <code>6</code>，是则继续执行之后的语句，否则直接跳到 40163f: <code>mov 0x68(%rsp),%rax</code> 返回。</p>
<p><code>0x202181(%rip)</code> 也就是 <code>(0x603760)</code> 存放的是什么？通过 gdb 发现，这个值的初始值为 <code>0</code>，而每通过一关后，这个值便加 <code>1</code>。结合注释（即变量名）<code># 603760</code>，推测它表示输入过的字符串数量，实际上也就是通过的关卡数量。<br>因此，隐藏关卡只有6个关卡都顺利通过后才会开启。<br>下面这段直接照搬别人的回答了：<br>剩下的片段也就是本函数与隐藏关相关的主体部分。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">4015e1:   4c 8d 44 24 10          lea    0x10(%rsp),%r8  </span><br><span class="line">4015e6:   48 8d 4c 24 0c          lea    0xc(%rsp),%rcx  </span><br><span class="line">4015eb:   48 8d 54 24 08          lea    0x8(%rsp),%rdx  </span><br><span class="line">4015f0:   be 19 26 40 00          mov    <span class="variable">$0x402619</span>,%esi  </span><br><span class="line">4015f5:   bf 70 38 60 00          mov    <span class="variable">$0x603870</span>,%edi  </span><br><span class="line">4015fa:   e8 f1 f5 ff ff          callq  400bf0 &lt;__isoc99_sscanf@plt&gt;</span><br></pre></td></tr></table></figure>

<p>这段代码我们已经十分熟悉。<code>0x402619</code> 指向的应该是一个格式化字符串。使用 gdb 查看地址 <code>0x402619</code> 存放的内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x402619:       <span class="string">&quot;%d %d %s&quot;</span></span><br></pre></td></tr></table></figure>
<p>因此，在某处我们需要按这个格式输入 2 个整数和 1 个字符串。这 2 个整数将被保存在 <code>0x8(%rsp)</code> 和 <code>0xc(%rsp)</code> 中，字符串将被保存在 <code>0x10(%rsp)</code> 中。需要注意的是这里还额外传入了一个地址 <code>0x603870</code>，根据我对系统函数 <code>sscanf</code> 的理解，这应当指的是那个被用来解析的字符串的地址。</p>
<p>读取完毕后，栈内保存的信息为：</p>
<blockquote>
<p>0x8(%rsp) = nums[0]<br>    0xc(%rsp) = nums[1]<br>    0x10(%rsp) = password</p>
</blockquote>
<p>其中，<code>nums[0]</code> 和 <code>nums[1]</code> 表示 <code>0x603870</code> 指向的字符串中解析得到的（前）2 个整数，<code>password</code> 表示之后解析得到的（前）1 个字符串。<br>在函数 <code>phase_defused</code> 的入口处设置一个断点。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) b phase_defused</span><br></pre></td></tr></table></figure>
<p>每通过一个关卡后，使用 gdb 查看地址 <code>0x603870</code> 存放的内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/s 0x603870</span><br></pre></td></tr></table></figure>
<p>发现在通过 Phase 4 后，输出信息产生了变化：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x603870 &lt;input_strings+240&gt;:   &quot;7 0&quot;</span><br></pre></td></tr></table></figure>
<p>可见，<code>0x603870</code> 指向的是 Phase 4 中输入的字符串 <code>7 0</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">4015ff:   83 f8 03                cmp    <span class="variable">$0x3</span>,%eax  </span><br><span class="line">401602:   75 31                   jne    401635 &lt;phase_defused+0x71&gt;  </span><br><span class="line">...  </span><br><span class="line">401630:   e8 0d <span class="built_in">fc</span> ff ff          callq  401242 &lt;secret_phase&gt;  </span><br><span class="line">401635:   bf 58 25 40 00          mov    <span class="variable">$0x402558</span>,%edi  </span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>4015ff: <code>cmp $0x3,%eax</code> 和 401602: <code>jne 401635</code> 判断函数 <code>sscanf</code> 的返回值是否为 <code>3</code>，是则继续执行之后的语句，否则直接跳到 401635: <code>mov $0x402558,%edi</code>，也就是跳过了隐藏关。</p>
<p>于是我们知道，在 Phase 4 中除了需要输入作为密码的 2 个整数外，还需要再额外输入 1 个字符串。这是开启隐藏关的前提条件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">401604:   be 22 26 40 00          mov    <span class="variable">$0x402622</span>,%esi  </span><br><span class="line">401609:   48 8d 7c 24 10          lea    0x10(%rsp),%rdi  </span><br><span class="line">40160e:   e8 25 fd ff ff          callq  401338 &lt;strings_not_equal&gt;  </span><br><span class="line">401613:   85 c0                   <span class="built_in">test</span>   %eax,%eax  </span><br><span class="line">401615:   75 1e                   jne    401635 &lt;phase_defused+0x71&gt;  </span><br><span class="line">...  </span><br><span class="line">401630:   e8 0d <span class="built_in">fc</span> ff ff          callq  401242 &lt;secret_phase&gt;  </span><br><span class="line">401635:   bf 58 25 40 00          mov    <span class="variable">$0x402558</span>,%edi  </span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>这里我们应该非常熟悉了，直接使用gdb查看地址0x402622存放的内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/s 0x402622</span><br><span class="line">0x402622:       <span class="string">&quot;DrEvil&quot;</span></span><br></pre></td></tr></table></figure>
<p>所以我们开启隐藏关就是在运行到phase 4的时候，在gdb中输入修改后的字符串:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">7 0 DrEvil <span class="comment"># 这里前两个数字，即第4关任意一个答案都行</span></span><br></pre></td></tr></table></figure>
<p>然后一直到我们输完所有答案，就会显示进入隐藏关卡了：<br><img src="20230106193740.png"></p>
<p>然后阅读secret_phase：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">0000000000401242 &lt;secret_phase&gt;:</span><br><span class="line">  401242: 53                    push   %rbx  </span><br><span class="line">  401243: e8 56 02 00 00        callq  40149e &lt;read_line&gt;</span><br><span class="line">  401248: ba 0a 00 00 00        mov    <span class="variable">$0xa</span>,%edx</span><br><span class="line">  40124d: be 00 00 00 00        mov    <span class="variable">$0x0</span>,%esi</span><br><span class="line">  401252: 48 89 c7              mov    %rax,%rdi</span><br><span class="line">  401255: e8 76 f9 ff ff        callq  400bd0 &lt;strtol@plt&gt; //string to long </span><br><span class="line">  40125a: 48 89 c3              mov    %rax,%rbx</span><br><span class="line">  40125d: 8d 40 ff              lea    -0x1(%rax),%eax</span><br><span class="line">  401260: 3d e8 03 00 00        cmp    <span class="variable">$0x3e8</span>,%eax</span><br><span class="line">  401265: 76 05                 jbe    40126c &lt;secret_phase+0x2a&gt;</span><br><span class="line">  401267: e8 ce 01 00 00        callq  40143a &lt;explode_bomb&gt;</span><br><span class="line">  40126c: 89 de                 mov    %ebx,%esi</span><br><span class="line">  40126e: bf f0 30 60 00        mov    <span class="variable">$0x6030f0</span>,%edi <span class="comment"># 这里将0x6030f0的值传给fun7</span></span><br><span class="line">  401273: e8 8c ff ff ff        callq  401204 &lt;fun7&gt;</span><br><span class="line"></span><br><span class="line">  401278: 83 f8 02              cmp    <span class="variable">$0x2</span>,%eax</span><br><span class="line">  40127b: 74 05                 je     401282 &lt;secret_phase+0x40&gt;</span><br><span class="line">  40127d: e8 b8 01 00 00        callq  40143a &lt;explode_bomb&gt;</span><br><span class="line">  401282: bf 38 24 40 00        mov    <span class="variable">$0x402438</span>,%edi <span class="comment">#check &quot;Wow! You&#x27;ve defused the secret stage!&quot;</span></span><br><span class="line">  401287: e8 84 f8 ff ff        callq  400b10 &lt;puts@plt&gt;</span><br><span class="line">  40128c: e8 33 03 00 00        callq  4015c4 &lt;phase_defused&gt;</span><br><span class="line">  401291: 5b                    pop    %rbx</span><br><span class="line">  401292: c3                    retq </span><br></pre></td></tr></table></figure>

<p>通过上面发现，如果func2返回2，就算通过彩蛋了。<br>func7如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">0000000000401204 &lt;fun7&gt;:</span><br><span class="line">  401204: 48 83 ec 08           sub    <span class="variable">$0x8</span>,%rsp</span><br><span class="line">  401208: 48 85 ff              <span class="built_in">test</span>   %rdi,%rdi</span><br><span class="line">  40120b: 74 2b                 je     401238 &lt;fun7+0x34&gt;</span><br><span class="line">  40120d: 8b 17                 mov    (%rdi),%edx </span><br><span class="line">  40120f: 39 f2                 cmp    %esi,%edx</span><br><span class="line">  401211: 7e 0d                 jle    401220 &lt;fun7+0x1c&gt;</span><br></pre></td></tr></table></figure>
<p>上面我们取了<code>m[rdi]=m[0x6030f0]</code>的值然后和<code>esi</code>也就是我们输入的值进行比较。不如先看看<code>0x6030f0</code>里放了些什么 这里我们把本题要用到的全部取出来。感觉上应该是一个树结构。因为每一个结点都有两个指针域和一个值域。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/120 0x6030f0 </span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">0x6030f0 &lt;n1&gt;:   0x0000000000000024      0x0000000000603110  </span><br><span class="line">0x603100 &lt;n1+16&gt;:        0x0000000000603130       0x0000000000000000  </span><br><span class="line">0x603110 &lt;n21&gt;:  0x0000000000000008      0x0000000000603190  </span><br><span class="line">0x603120 &lt;n21+16&gt;:       0x0000000000603150       0x0000000000000000  </span><br><span class="line">0x603130 &lt;n22&gt;:  0x0000000000000032      0x0000000000603170  </span><br><span class="line">0x603140 &lt;n22+16&gt;:       0x00000000006031b0       0x0000000000000000  </span><br><span class="line">0x603150 &lt;n32&gt;:  0x0000000000000016      0x0000000000603270  </span><br><span class="line">0x603160 &lt;n32+16&gt;:       0x0000000000603230       0x0000000000000000  </span><br><span class="line">0x603170 &lt;n33&gt;:  0x000000000000002d      0x00000000006031d0  </span><br><span class="line">0x603180 &lt;n33+16&gt;:       0x0000000000603290       0x0000000000000000  </span><br><span class="line">0x603190 &lt;n31&gt;:  0x0000000000000006      0x00000000006031f0  </span><br><span class="line">0x6031a0 &lt;n31+16&gt;:       0x0000000000603250       0x0000000000000000  </span><br><span class="line">0x6031b0 &lt;n34&gt;:  0x000000000000006b      0x0000000000603210  </span><br><span class="line">0x6031c0 &lt;n34+16&gt;:       0x00000000006032b0       0x0000000000000000  </span><br><span class="line">0x6031d0 &lt;n45&gt;:  0x0000000000000028      0x0000000000000000  </span><br><span class="line">0x6031e0 &lt;n45+16&gt;:       0x0000000000000000       0x0000000000000000  </span><br><span class="line">0x6031f0 &lt;n41&gt;:  0x0000000000000001      0x0000000000000000  </span><br><span class="line">0x603200 &lt;n41+16&gt;:       0x0000000000000000       0x0000000000000000  </span><br><span class="line">0x603210 &lt;n47&gt;:  0x0000000000000063      0x0000000000000000  </span><br><span class="line">0x603220 &lt;n47+16&gt;:       0x0000000000000000       0x0000000000000000  </span><br><span class="line">0x603230 &lt;n44&gt;:  0x0000000000000023      0x0000000000000000  </span><br><span class="line">0x603240 &lt;n44+16&gt;:       0x0000000000000000       0x0000000000000000  </span><br><span class="line">0x603250 &lt;n42&gt;:  0x0000000000000007      0x0000000000000000  </span><br><span class="line">0x603260 &lt;n42+16&gt;:       0x0000000000000000       0x0000000000000000  </span><br><span class="line">0x603270 &lt;n43&gt;:  0x0000000000000014      0x0000000000000000  </span><br><span class="line">0x603280 &lt;n43+16&gt;:       0x0000000000000000       0x0000000000000000  </span><br><span class="line">0x603290 &lt;n46&gt;:  0x000000000000002f      0x0000000000000000  </span><br><span class="line">0x6032a0 &lt;n46+16&gt;:       0x0000000000000000       0x0000000000000000  </span><br><span class="line">0x6032b0 &lt;n48&gt;:  0x00000000000003e9      0x0000000000000000  </span><br><span class="line">0x6032c0 &lt;n48+16&gt;:       0x0000000000000000       0x0000000000000000</span><br></pre></td></tr></table></figure>
<p>可以发现这是一个二叉树。二叉树中每个结点是一个结构体，结点所在的地址指向的是数据 <code>val</code>，加上 <code>0x8</code> 后指向的是指针 <code>left</code>，加上 <code>0x10</code> 后指向的是指针 <code>right</code>。</p>
<p>因此，<code>fun7</code> 函数中的 <code>*p_node</code> 即 <code>p_node-&gt;val</code>，<code>*(p_node + 1)</code> 即 <code>p_node-&gt;left</code>，<code>*(p_node + 2)</code> 即 <code>p_node-&gt;right</code>。</p>
<p>根据之前 gdb 的输出信息绘制二叉树（数据已转化为十进制）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">            36  </span><br><span class="line">         ／        ＼  </span><br><span class="line">      8               50  </span><br><span class="line">   ／   ＼          ／   ＼  </span><br><span class="line">  6      22       45      107  </span><br><span class="line"> / \    /  \     /  \    /   \  </span><br><span class="line">1   7  20  35   40  47  99  1001</span><br></pre></td></tr></table></figure>
<p>再仔细观察发现这还是一棵BST</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">401213:	48 8b 7f 08          	mov    0x8(%rdi),%rdi</span><br><span class="line">  401217:	e8 e8 ff ff ff       	callq  401204 &lt;fun7&gt; //每次都向左走找到符合的值</span><br><span class="line">  40121c:	01 c0                	add    %eax,%eax</span><br><span class="line">  40121e:	eb 1d                	jmp    40123d &lt;fun7+0x39&gt;</span><br><span class="line">  401220:	b8 00 00 00 00       	mov    <span class="variable">$0x0</span>,%eax //%rax=0</span><br><span class="line">  401225:	39 f2                	cmp    %esi,%edx //r-&gt;val - input</span><br><span class="line">  401227:	74 14                	je     40123d &lt;fun7+0x39&gt; //=0 <span class="built_in">return</span> </span><br><span class="line">  401229:	48 8b 7f 10          	mov    0x10(%rdi),%rdi // 如果r-&gt;val小 去右边</span><br><span class="line">  40122d:	e8 d2 ff ff ff       	callq  401204 &lt;fun7&gt;</span><br><span class="line">  401232:	8d 44 00 01          	lea    0x1(%rax,%rax,1),%eax</span><br><span class="line">  401236:	eb 05                	jmp    40123d &lt;fun7+0x39&gt; </span><br><span class="line">  401238:	b8 ff ff ff ff       	mov    <span class="variable">$0xffffffff</span>,%eax //为空来这里</span><br><span class="line">  40123d:	48 83 c4 08          	add    <span class="variable">$0x8</span>,%rsp </span><br><span class="line">  401241:	c3                   	retq   </span><br></pre></td></tr></table></figure>
<p>用伪代码来解释上面的过程</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> res=<span class="number">0</span>;</span><br><span class="line">func(Bitree *r ,<span class="type">long</span> input)&#123;</span><br><span class="line"> <span class="keyword">if</span>(!r)<span class="keyword">return</span> <span class="number">0xffffffff</span></span><br><span class="line"> <span class="keyword">if</span>(r-&gt;val&lt;=input)&#123; </span><br><span class="line">     res=<span class="number">0</span>;</span><br><span class="line">     <span class="keyword">if</span>(r-&gt;val &lt;input)&#123;</span><br><span class="line">       func(r-&gt;right,input);</span><br><span class="line">       res=res*<span class="number">2</span>+<span class="number">1</span>;</span><br><span class="line">     &#125; </span><br><span class="line">     <span class="keyword">else</span> <span class="keyword">return</span> res;</span><br><span class="line">     </span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    func(r-&gt;left,input);</span><br><span class="line">    res*=<span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>函数 <code>fun7</code> 的作用为：</p>
<ol>
<li> 如果当前结点为 <code>NULL</code>，则返回 <code>0xffffffff</code>（直接爆了）；</li>
<li> 如果找到了 input，则返回 <code>0</code>；</li>
<li> 如果当前结点的值大于 <code>input</code>，则继续搜索左子树，返回时将左子树的返回值 <code>* 2</code>；</li>
<li> 如果当前结点的值小于 <code>input</code>，则继续搜索右子树，返回时将右子树的返回值 <code>* 2 + 1</code>。</li>
</ol>
<p>起始时从根结点 <code>36</code> 开始查找，现在问题转化为：求 <code>input</code> 为何值时，最终的返回值为 <code>2</code>。<br>由之前的分析，返回值为 <code>2</code> 的条件为：</p>
<ol>
<li> 最终找到 input 的值（<code>return 0</code>），此后可以沿右路返回任意次（<code>return 0</code>）；</li>
<li> 然后沿左路返回（<code>return 1</code>）；</li>
<li> 最后沿右路返回（<code>return 2</code>）。</li>
</ol>
<p>满足条件的结点的值有 2 个：<code>22</code>, <code>20</code>，即为所求。</p>
<p>于是得到本关的 2 个解：<code>22</code>, <code>20</code>。<br>这里以 <code>22</code> 为例，在 gdb 中输入 Secret phase 的密码：<br>22<br><img src="20230106201948.png"></p>
<h2 id="解题感受"><a href="#解题感受" class="headerlink" title="解题感受"></a>解题感受</h2><p>这个lab属实折磨，纯靠自己的话基本做不出来。也是边参考大佬的答案，边整理出来的。不过通过这个lab，也让自己对汇编的理解更加深入了。大家如果有能力的话，最好还是能自己做吧。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">wenwenka</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2023/01/10/CsApp-%E2%80%94%E2%80%94-bomblab/">http://example.com/2023/01/10/CsApp-%E2%80%94%E2%80%94-bomblab/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">温温卡的blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CsApp/">CsApp</a></div><div class="post_share"><div class="social-share" data-image="/2023/01/10/CsApp-%E2%80%94%E2%80%94-bomblab/cover.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/01/18/CsApp-%E2%80%94%E2%80%94-Attacklab/"><img class="prev-cover" src="/2023/01/18/CsApp-%E2%80%94%E2%80%94-Attacklab/cover.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">CsApp —— Attack Lab</div></div></a></div><div class="next-post pull-right"><a href="/2023/01/09/CsApp-%E2%80%94%E2%80%94-Data-Lab/"><img class="next-cover" src="/2023/01/09/CsApp-%E2%80%94%E2%80%94-Data-Lab/cover.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">CsApp —— Data Lab</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/01/18/CsApp-%E2%80%94%E2%80%94-Attacklab/" title="CsApp —— Attack Lab"><img class="cover" src="/2023/01/18/CsApp-%E2%80%94%E2%80%94-Attacklab/cover.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-18</div><div class="title">CsApp —— Attack Lab</div></div></a></div><div><a href="/2023/01/21/CsApp-%E2%80%94%E2%80%94-CacheLab/" title="CsApp —— Cache Lab"><img class="cover" src="/2023/01/21/CsApp-%E2%80%94%E2%80%94-CacheLab/cover.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-21</div><div class="title">CsApp —— Cache Lab</div></div></a></div><div><a href="/2023/01/09/CsApp-%E2%80%94%E2%80%94-Data-Lab/" title="CsApp —— Data Lab"><img class="cover" src="/2023/01/09/CsApp-%E2%80%94%E2%80%94-Data-Lab/cover.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-09</div><div class="title">CsApp —— Data Lab</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">wenwenka</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">6</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">2</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">2</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/wenwenka" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="/wu290063155@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-5"><a class="toc-link" href="#cgdb%E7%9A%84%E7%9B%B8%E5%85%B3%E7%94%A8%E6%B3%95%EF%BC%9A"><span class="toc-number">1.</span> <span class="toc-text">cgdb的相关用法：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#phase-1"><span class="toc-number"></span> <span class="toc-text">phase_1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#phase-2"><span class="toc-number"></span> <span class="toc-text">phase_2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#phase-3"><span class="toc-number"></span> <span class="toc-text">phase_3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#phase-4"><span class="toc-number"></span> <span class="toc-text">phase_4</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#phase-5"><span class="toc-number"></span> <span class="toc-text">phase_5</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#phase-6"><span class="toc-number"></span> <span class="toc-text">phase_6</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8E%E8%AE%B0"><span class="toc-number"></span> <span class="toc-text">后记</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E9%A2%98%E6%84%9F%E5%8F%97"><span class="toc-number"></span> <span class="toc-text">解题感受</span></a></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/05/13/%E5%AE%8C%E6%88%90%E5%A4%A7%E8%AE%BA%E6%96%87/" title="完成大论文"><img src="/img/cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="完成大论文"/></a><div class="content"><a class="title" href="/2023/05/13/%E5%AE%8C%E6%88%90%E5%A4%A7%E8%AE%BA%E6%96%87/" title="完成大论文">完成大论文</a><time datetime="2023-05-13T10:20:31.000Z" title="发表于 2023-05-13 18:20:31">2023-05-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/01/21/CsApp-%E2%80%94%E2%80%94-CacheLab/" title="CsApp —— Cache Lab"><img src="/2023/01/21/CsApp-%E2%80%94%E2%80%94-CacheLab/cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CsApp —— Cache Lab"/></a><div class="content"><a class="title" href="/2023/01/21/CsApp-%E2%80%94%E2%80%94-CacheLab/" title="CsApp —— Cache Lab">CsApp —— Cache Lab</a><time datetime="2023-01-21T14:42:00.000Z" title="发表于 2023-01-21 22:42:00">2023-01-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/01/18/CsApp-%E2%80%94%E2%80%94-Attacklab/" title="CsApp —— Attack Lab"><img src="/2023/01/18/CsApp-%E2%80%94%E2%80%94-Attacklab/cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CsApp —— Attack Lab"/></a><div class="content"><a class="title" href="/2023/01/18/CsApp-%E2%80%94%E2%80%94-Attacklab/" title="CsApp —— Attack Lab">CsApp —— Attack Lab</a><time datetime="2023-01-18T14:07:00.000Z" title="发表于 2023-01-18 22:07:00">2023-01-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/01/10/CsApp-%E2%80%94%E2%80%94-bomblab/" title="CsApp —— Bomb Lab"><img src="/2023/01/10/CsApp-%E2%80%94%E2%80%94-bomblab/cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CsApp —— Bomb Lab"/></a><div class="content"><a class="title" href="/2023/01/10/CsApp-%E2%80%94%E2%80%94-bomblab/" title="CsApp —— Bomb Lab">CsApp —— Bomb Lab</a><time datetime="2023-01-10T15:07:12.000Z" title="发表于 2023-01-10 23:07:12">2023-01-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/01/09/CsApp-%E2%80%94%E2%80%94-Data-Lab/" title="CsApp —— Data Lab"><img src="/2023/01/09/CsApp-%E2%80%94%E2%80%94-Data-Lab/cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CsApp —— Data Lab"/></a><div class="content"><a class="title" href="/2023/01/09/CsApp-%E2%80%94%E2%80%94-Data-Lab/" title="CsApp —— Data Lab">CsApp —— Data Lab</a><time datetime="2023-01-09T15:07:12.000Z" title="发表于 2023-01-09 23:07:12">2023-01-09</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By wenwenka</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>